/*! SoftwareRenderer - ver. 0.1.0 */
OBJmodel=function(){function a(){this.verts=[],this.faces=[],this.normals=[],this.texcoords=[]}return a.parse=function(a,b){for(var c=function(b){return a[b].split(" ").splice(1,3)},d=0;d<a.length;d++)switch(a[d].substr(0,2)){case"v ":b.verts.push(new f32a(c(d)));break;case"vn":b.normals.push(new f32a(c(d)));break;case"vt":b.texcoords.push(new f32a(c(d)));break;case"f ":for(var e=c(d),f=0;3>f;f++)e[f]=e[f].split("/").map(function(a){return parseInt(a-1)});b.faces.push(e)}},a}(),Matrix=function(){function a(){}return a.identity=function(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},a.rotation=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return[[1-2*c*c-2*d*d,2*b*c+2*d*e,2*b*d-2*c*e,0],[2*b*c-2*d*e,1-2*b*b-2*d*d,2*d*c+2*b*e,0],[2*b*d+2*c*e,2*d*c-2*b*e,1-2*b*b-2*c*c,0],[0,0,0,1]]},a.projection=function(b,c,d){var e=a.identity();return e[3][2]=coeff,e},a.view=function(b,c,d){for(var e=Vec3.normalize([b[0]-c[0],b[1]-c[1],b[2]-c[2]]),f=Vec3.normalize(Vec3.cross(d,z)),d=Vec3.normalize(Vec3.cross(e,f)),g=a.identity(),h=0;3>h;h++)g[0][h]=f[h],g[1][h]=d[h],g[2][h]=e[h];return g[3][0]=-Vec3.dot(f,b),g[3][1]=-Vec3.dot(d,b),g[3][2]=-Vec3.dot(e,b),g},a}(),Quaternion=function(){function a(){}return a.fromEuler=function(a,b,c){var d,e,f,g,h,i;return g=m.sin(.5*a),d=m.cos(.5*a),h=m.sin(.5*b),e=m.cos(.5*b),i=m.sin(.5*c),f=m.cos(.5*c),[d*e*f+g*h*i,g*e*f-d*h*i,d*h*f+g*e*i,d*e*i-g*h*f]},a}(),Vec3=function(){function a(){}return a.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},a.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},a.reflect=function(b,c){var d=a.dot(b,c),e=[2*c[0]*d,2*c[1]*d,2*c[2]*d];return[e[0]-b[0],e[1]-b[1],e[2]-b[2]]},a.dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return m.sqrt(b)},a.normalize=function(b){var c=1/a.dist(b);return[b[0]*c,b[1]*c,b[2]*c]},a}(),orient2d=function(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(b[1]-a[1])*(c[0]-a[0])},Buffer=function(){function a(a,b,c){this.ctx=a,this.w=b,this.h=c,this.calls=0,this.pixels=0,this.imgData=a.createImageData(this.w,this.h),this.buf=new ArrayBuffer(this.imgData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf),this.zbuf=new Uint32Array(this.imgData.data.length),this.points=new Int32Array(3)}return a.prototype={clear:function(a){for(var b=0;b<=this.h;b++)for(var c=0;c<this.w;c++){var d=b*this.w+c;this.set(c,b,a),this.zbuf[d]=0}},set:function(a,b,c){var d=255&c[0]|(255&c[1])<<8|(255&c[2])<<16;this.buf32[b*this.w+a]=4278190080|d},get:function(a,b){return this.buf32[b*this.w+a]},indexTriangle:function(a,c,d){for(var e=[a[0][0],a[1][0],a[2][0]],f=[a[0][1],a[1][1],a[2][1]],h=[a[0][2],a[1][2],a[2][2]],i=[this.w+1,this.h+1],j=[-1,-1],k=0;k<e.length;k++)for(var l=0;2>l;l++)i[l]=m.min(e[k][l],i[l]),j[l]=m.max(e[k][l],j[l]);if(!(i[0]>this.w||j[0]<0||i[1]>this.h||j[1]<0))for(var n,o,p,q,s=new f32a(2),t=new f32a(3),u=e[0][1]-e[1][1],v=e[1][0]-e[0][0],w=e[1][1]-e[2][1],x=e[2][0]-e[1][0],y=e[2][1]-e[0][1],z=e[0][0]-e[2][0],A=e[1][1]-e[0][1],B=e[2][1]-e[1][1],C=1/(v*B-x*A),D=orient2d(e[1],e[2],i),E=orient2d(e[2],e[0],i),F=orient2d(e[0],e[1],i),G=[0,0,0],H=i[1];H<=j[1];H++){for(var I=[D,E,F],J=i[0];J<=j[0];J++){if(this.pixels++,(I[0]|I[1]|I[2])>0){t[0]=I[0]*C,t[1]=I[1]*C,t[2]=I[2]*C,q=0;for(var k=0;3>k;k++)q+=e[k][2]*t[k];var K=H*this.w+J;if(this.zbuf[K]<q){var n,o,p;s[0]=t[0]*f[0][0]+t[1]*f[1][0]+t[2]*f[2][0],s[1]=t[0]*f[0][1]+t[1]*f[1][1]+t[2]*f[2][1],n=t[0]*h[0][0]+t[1]*h[1][0]+t[2]*h[2][0],o=t[0]*h[0][1]+t[1]*h[1][1]+t[2]*h[2][1],p=t[0]*h[0][2]+t[1]*h[1][2]+t[2]*h[2][2];var L=c.fragment([s,[n,o,p],a[0][3]],G);if(b=255&d,g=d>>8&255,r=d>>16&255,!L){this.zbuf[K]=q,this.set(J,H,G),this.calls++}}}I[0]+=w,I[1]+=y,I[2]+=u}D+=x,E+=z,F+=v}},indexTrianglex4:function(a,b,c,d,e,f){points=[a[0][0],a[1][0],a[2][0]];for(var g=[a[0][1],a[1][1],a[2][1]],h=[a[0][2],a[1][2],a[2][2]],i=[this.w+1,this.h+1],j=[-1,-1],k=0;k<points.length;k++)for(var l=0;2>l;l++)i[l]=m.min(points[k][l],i[l]),j[l]=m.max(points[k][l],j[l]);if(!(i[0]>this.w||j[0]<0||i[1]>this.h||j[1]<0))for(var n,o=SIMD.Float32x4(points[1][1]-points[2][1],points[2][1]-points[0][1],points[0][1]-points[1][1],0),p=SIMD.Float32x4(points[2][0]-points[1][0],points[0][0]-points[2][0],points[1][0]-points[0][0],0),q=points[1][1]-points[0][1],r=points[2][1]-points[1][1],s=1/((points[1][0]-points[0][0])*r-(points[2][0]-points[1][0])*q),t=SIMD.Float32x4(orient2d(points[1],points[2],i),orient2d(points[2],points[0],i),orient2d(points[0],points[1],i),0),u=(SIMD.Float32x4.splat(0),SIMD.Float32x4.splat(s)),v=[0,0,0],w=i[1];w<=j[1];w++){for(var x=t,y=i[0];y<=j[0];y++){if(this.pixels++,SIMD.Float32x4.store(f,0,x),(f[0]|f[1]|f[2])>0){var z=SIMD.Float32x4.mul(x,u);SIMD.Float32x4.store(c,0,z),n=0;for(var k=0;3>k;k++)n+=points[k][2]*c[k];var A=w*this.w+y;if(this.zbuf[A]<n){d[0]=c[0]*g[0][0]+c[1]*g[1][0]+c[2]*g[2][0],d[1]=c[0]*g[0][1]+c[1]*g[1][1]+c[2]*g[2][1],e[0]=c[0]*h[0][0]+c[1]*h[1][0]+c[2]*h[2][0],e[1]=c[0]*h[0][1]+c[1]*h[1][1]+c[2]*h[2][1],e[2]=c[0]*h[0][2]+c[1]*h[1][2]+c[2]*h[2][2];var B=b.fragment([d,e,a[0][3]],v);if(!B){this.zbuf[A]=n,this.set(y,w,v),this.calls++}}}x=SIMD.Float32x4.add(x,o)}t=SIMD.Float32x4.add(t,p)}},draw:function(){this.imgData.data.set(this.buf8),this.ctx.putImageData(this.imgData,0,0)}},a}(),Effect=function(){function a(){}return a.prototype={vertex:function(a){},fragment:function(a,b){},setParameters:function(a){var b=this;Object.keys(a).map(function(c){b[c]=a[c]})}},a}(),Texture=function(){function a(a,b,c){this.texData=b,this.buf32=c,this.source=a,this.sample=function(a,b){this.texData.data;const c=m.round(b[0]*this.texData.width),d=m.round(b[1]*this.texData.height);return i=(this.texData.height-d)*this.texData.width+c,smp=this.buf32[i],[255&smp,smp>>8&255,smp>>16&255,smp>>24&255]}}return a.load=function(b){texCanvas=document.createElement("canvas"),ctx=texCanvas.getContext("2d"),texCanvas.width=b.width,texCanvas.height=b.height,ctx.drawImage(b,0,0),b.style.display="none";for(var c=ctx.getImageData(0,0,b.width,b.height),d=new ArrayBuffer(c.data.length),e=new Uint32Array(d),f=0;f<e.length;f++){var g=c.data,h=f<<2;e[f]=g[h]|g[h+1]<<8|g[h+2]<<16|g[h+3]<<24}return new a(b.src,c,e)},a}(),ContentManager=function(){function a(){}function b(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})}function c(a){}function d(){i++,i==j&&h(k)}function e(a,e){j++;var f=function(a){if(null!=e){var b=new OBJmodel,c=a.split("\n");OBJmodel.parse(c,b),k[e]=b,d()}};return b(a).then(f,c)}function f(a,e){j++;var f=function(b){if(null!=e){var c=new Image;c.src=a,c.onload=function(){var a=Texture.load(c);k[e]=a,d()}}};return b(a).then(f,c)}function g(a,b){j++;var c=document.createElement("script");c.src=a,c.onload=function(){null!=b&&b(),d()},document.head.appendChild(c)}var h,i=0,j=0,k={};return a.prototype={load:function(a){return function(b,c){switch(c="undefined"!=typeof c?c:null,a){case"Model":return e(b,c);case"Texture":return f(b,c);case"Effect":return g(b,c)}}},contentCollection:function(){return k},finishedLoading:function(a){h=a}},a}(),function(){m=Math,doc=document,f32a=Float32Array,f64a=Float64Array,simdSupported="undefined"!=typeof SIMD,Renderer=function(){function a(){}var b,c,d,e=m.PI;if(simdSupported)var f=new f32a(4),g=new f32a(2),h=new f32a(4),i=new f32a(3);return drawImage=function(){b.clear([0,0,0]),start=new Date;var a=1;c.setParameters({r:e});for(var j=0;j<d.faces.length;j++){for(var k=[],l=d.faces[j],n=0;3>n;n++){var o=d.verts[l[n][0]],p=d.texcoords.length>0?d.texcoords[l[n][1]]:[0,0],q=d.normals.length>0?d.normals[l[n][2]]:[1,0,0],r=[o,p,q],s=c.vertex(r);k.push(s)}simdSupported?b.indexTrianglex4(k,c,f,g,i,h):b.indexTriangle(k,c,a++)}b.draw(),e+=m.max(.001*((new Date).getTime()-start.getTime()),1/60);var t="Frame took "+((new Date).getTime()-start.getTime())+" ms",u="Pixels drawn/found "+b.calls+"/"+b.pixels;doc.getElementById("info").innerHTML=t+"<br/>"+u,b.calls=0,b.pixels=0,requestAnimationFrame(function(){drawImage()})},a.prototype={ready:function(a){return function(e){d=e.model,c=new DefaultEffect;var f=e.model_diff,g=e.model_nrm,h=a.getContext("2d"),i=doc.getElementById("render_start");b=new Buffer(h,a.width,a.height),c.setParameters({scr_w:b.w,scr_h:b.h,texture:f,texture_nrm:g}),i.style.display="block",i.onclick=function(){startProfile=new Date,drawImage()}}}},a}()}();