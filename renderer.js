/*! SoftwareRenderer - ver. 0.1.0 */
function modelReady(a,b){var c=function(){console.log("ready to render!");var c=Object.create(Effect),d=Object.create(Texture);d.load("obj/diablo3_pose_diffuse.png");var e=b.getContext("2d"),f=doc.getElementById("render_start");f.style.display="block",f.onclick=function(){console.log("Begin render!");var f=Object.create(Buffer);f.init(e,b.width,b.height),c.setParameters({scr_w:f.w,scr_h:f.h,texture:d}),drawImage(a,f,c)}};return c}function drawImage(a,b,c){start=new Date,console.log((new Date).getTime()-start.getTime()+"ms Crunching triangles");for(var d=0;d<a.faces.length;d++){for(var e=a.faces[d],f=[],g=0;3>g;g++){var h=a.verts[e[g][0]];f.push(c.vertex(h))}b.triangle(f,c)}console.log((new Date).getTime()-start.getTime()+"ms Drawing triangles"),console.log((new Date).getTime()-start.getTime()+"ms Post-processing"),b.drawBuffer(),b.draw()}var OBJmodel={verts:[],faces:[],normals:[],texcoords:[],request:function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})},load:function(a,b){var c=this,d=function(a){var d=a.split("\n");c.parse(d),b()},e=function(a){console.error("request failed!")};c.request(a).then(d,e)},parse:function(a){for(var b=function(b){return a[b].split(" ").splice(1,3)},c=0;c<a.length;c++)switch(a[c].substr(0,2)){case"v ":this.verts.push(b(c));break;case"vn":this.normals.push(b(c));break;case"vt":this.texcoords.push(b(c));break;case"f ":for(var d=b(c),e=0;3>e;e++)d[e]=d[e].split("/").map(function(a){return parseInt(a-1)});this.faces.push(d)}console.log("total verts: "+this.verts.length),console.log("total normals: "+this.normals.length),console.log("total faces: "+this.faces.length)}},Buffer={ctx:null,imgData:null,init:function(a,b,c){this.ctx=a,this.calls=0,this.pixelVal=0,this.w=b,this.h=c,this.nextline=c,this.log2w=1;for(var d=b;d>>=1;)this.log2w++;var d=1<<this.log2w;this.imgData=a.createImageData(d,this.h),this.buf=new ArrayBuffer(this.imgData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf),this.zbuf=new Uint32Array(this.imgData.data.length)},clear:function(a){const b=this.buf32.length;for(var c=0;b>c;c++)this.buf32[c]=a+4278190080},index:function(a,b){return(this.h-b<<this.log2w)+a},set:function(a,b,c){this.buf32[this.index(a,b)]=c+4278190080},get:function(a,b){return this.buf32[this.index(a,b)]},triangle:function(a,b){for(var c=[this.w+1,this.h+1],d=[-1,-1],e=0;e<a.length;e++)for(var f=0;2>f;f++)c[f]=m.min(a[e][f],c[f]),d[f]=m.max(a[e][f],d[f]);if(!(c[0]>this.w||d[0]<0||c[1]>this.h||d[1]<0))for(var g=0,h=c[1];h<=d[1];h++)for(var i=c[0];i<=d[0];i++){this.pixelVal++;var j=barycentric(a,[i,h,g]);if(!(j[0]<0||j[1]<0||j[2]<0)){g=0;for(var e=0;3>e;e++)g+=a[e][2]*j[e];var k=this.index(i,h),l=[0],n=b.fragment(j,l);this.zbuf[k]<g&&!n&&(this.zbuf[k]=g,this.set(i,h,l[0]),this.calls++)}}},draw:function(){var a=this;if(a.nextline<0){console.log("Done!"),end=new Date;var b="Execution took "+(end.getTime()-start.getTime())+" ms",c="Pixel draw calls/visited: "+this.calls+"/"+this.pixelVal;return doc.getElementById("info").innerHTML=b+"<br/>"+c,void console.log(b+". "+c)}requestAnimationFrame(function(){a.draw()}),this.postProc(a.nextline),this.drawBuffer(),a.nextline-=32},postProc:function(a){for(var b=[],c=0;c<2*m.PI-1e-4;c+=m.PI/5)b.push([m.sin(c),m.cos(c)]);for(var d=a;d>a-32;d--)for(var e=0;e<this.w;e++){var f=this.index(e,d);if(!(this.zbuf[f]<1e-5)){for(var g=0,h=0;h<b.length;h++)g+=m.PI/2-m.atan(max_elevation_angle(this.zbuf,f,[e,d],[this.w,this.h],b[h],this.log2w));g/=m.PI/2*10;var i=255*g;this.set(e,d,i|i<<8|i<<16),this.calls++}}},drawBuffer:function(){this.imgData.data.set(this.buf8),this.ctx.putImageData(this.imgData,0,0)}},Effect={vertex:function(a){var b=this.scr_h/this.scr_w,c=m.floor((a[0]/2+.5/b)*this.scr_w*b),d=m.floor((a[1]/2+.5)*this.scr_h),e=m.floor(32768*(a[2]/2+.5));return[c,d,e]},fragment:function(a,b){return b[0]=16711680,b[0]=this.texture.sample(null,[.5,.5]),!1},setParameters:function(a){var b=this;Object.keys(a).map(function(c){b[c]=a[c]})}},Texture={texData:null,sampled:!1,source:"",load:function(a){var b=this;img=new Image,img.src=a,img.onload=function(){texCanvas=document.createElement("canvas"),ctx=texCanvas.getContext("2d"),texCanvas.width=img.width,texCanvas.height=img.height,ctx.drawImage(img,0,0),img.style.display="none",b.texData=ctx.getImageData(0,0,img.width,img.height),console.log(b.texData)}},sample:function(a,b){var c=this.texData.data;return x=512,y=512,i=y*this.texData.width+x,c[i]|c[i+1]<<8|c[i+2]<<16|c[i+3]<<24}};vecAdd=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]+b[d]);return c},vecSub=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]-b[d]);return c},dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return m.sqrt(b)},normalize=function(a){var b=dist(a);return[a[0]/b,a[1]/b,a[2]/b]},barycentric=function(a,b){var c=vecSub(a[1],a[0]),d=vecSub(a[2],a[0]),e=vecSub(b,a[0]),f=1/(c[0]*d[1]-d[0]*c[1]);return v=(e[0]*d[1]-d[0]*e[1])*f,w=(c[0]*e[1]-e[0]*c[1])*f,u=1-v-w,[u,v,w]},max_elevation_angle=function(a,b,c,d,e,f){for(var g=0,h=0;30>h;h++){var i=vecAdd(c,[e[0]*h,e[1]*h]);if(i[0]>=d[0]||i[1]>=d[1]||i[0]<0||i[1]<0)return g;var j=dist(vecSub(c,i));if(!(1>j)){var k=(d[1]-m.floor(i[1])<<f)+m.floor(i[0]),l=.0078125*(a[k]-a[b]);g=m.max(g,l/j)}}return g};var m=Math,doc=document;(function(){var a=doc.getElementById("render"),b=Object.create(OBJmodel);a.getContext?b.load("obj/diablo3.obj",modelReady(b,a)):console.error("Canvas context not supported!")}).call(this);