/*! SoftwareRenderer - ver. 0.1.0 */
function modelReady(a,b){var c=function(){console.log("ready to render!");var c=b.getContext("2d"),d=document.getElementById("render_start");d.style.display="block",d.onclick=function(){console.log("Begin render!");var d=Object.create(Img);d.init(c,b.width,b.height),drawImage(a,d)}};return c}function drawImage(a,b){start=new Date;var c=b.h/b.w,d=[],e=[];console.log((new Date).getTime()-start.getTime()+"ms Crunching triangles");for(var f=0;f<a.faces.length;f++)for(var g=a.faces[f],h=0;3>h;h++){var i=a.verts[g[h][0]],j=m.floor((i[0]/2+.5/c)*b.w*c),k=m.floor((i[1]/2+.5)*b.h),l=m.floor(32768*(i[2]/2+.5));e.push([j,k,l]),d.push(i)}console.log((new Date).getTime()-start.getTime()+"ms Drawing triangles");for(var n=0;n<d.length;n+=3){var o=cross(vecSub(d[n+2],d[n]),vecSub(d[n+1],d[n])),p=dot(normalize(o),[0,0,-1]),q=255*p,r=[e[n],e[n+1],e[n+2]];p>0&&b.triangle(r,q|q<<8|q<<16)}console.log((new Date).getTime()-start.getTime()+"ms Post-processing"),b.postProc(),b.flush(),end=new Date;var s="Execution took "+(end.getTime()-start.getTime())+" ms",t="Pixel draw calls/visited: "+b.calls+"/"+b.pixelVal;document.getElementById("info").innerHTML=s+"<br/>"+t,console.log(s+". "+t),b.calls=0,b.pixelVal=0}var OBJmodel={verts:[],faces:[],normals:[],request:function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})},load:function(a,b){var c=this,d=function(a){var d=a.split("\n");c.parse(d),b()},e=function(a){console.error("request failed!")};c.request(a).then(d,e)},parse:function(a){for(var b=function(a,b){return a[b].split(" ").splice(1,3)},c=0;c<a.length;c++)switch(a[c].substr(0,2)){case"v ":this.verts.push(b(a,c));break;case"vn":this.normals.push(b(a,c));break;case"f ":for(var d=b(a,c),e=0;3>e;e++)d[e]=d[e].split("/").map(function(a){return parseInt(a-1)});this.faces.push(d)}console.log("total verts: "+this.verts.length),console.log("total normals: "+this.normals.length),console.log("total faces: "+this.faces.length)}};(function(){var a=document.getElementById("render"),b=Object.create(OBJmodel);a.getContext?b.load("obj/diablo3.obj",modelReady(b,a)):console.error("Canvas context not supported!")}).call(this);var m=Math,Img={ctx:null,imgData:null,init:function(a,b,c){this.ctx=a,this.calls=0,this.pixelVal=0;var d=a.canvas.clientWidth;for(this.log2w=1;d>>=1;)this.log2w++;d=1<<this.log2w,this.w=b,this.h=c,this.imgData=a.createImageData(d,this.h),this.buf=new ArrayBuffer(this.imgData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf),this.zbuf=new Uint32Array(this.imgData.data.length)},clear:function(a){const b=this.buf32.length;for(var c=0;b>c;c++)this.buf32[c]=a+4278190080},index:function(a,b){return(this.h-b<<this.log2w)+a},set:function(a,b,c){this.buf32[this.index(a,b)]=c+4278190080},get:function(a,b){return this.buf32[this.index(a,b)]},triangle:function(a,b){for(var c=[this.w+1,this.h+1],d=[-1,-1],e=0;e<a.length;e++)for(var f=0;2>f;f++)c[f]=m.min(a[e][f],c[f]),d[f]=m.max(a[e][f],d[f]);const g=[c,d];if(!(g[0][0]>this.w||g[1][0]<0||g[0][1]>this.h||g[1][1]<0))for(var h=0,i=g[0][1];i<=g[1][1];i++)for(var j=g[0][0];j<=g[1][0];j++){this.pixelVal++;var k=barycentric(a,[j,i,h]);if(!(k[0]<0||k[1]<0||k[2]<0)){h=0;for(var e=0;3>e;e++)h+=a[e][2]*k[e];var l=this.index(j,i);if(this.zbuf[l]<h){var n=h>>8;this.zbuf[l]=h,this.set(j,i,n|n<<8|n<<16)}}}},postProc:function(){for(var a=0;a<this.h;a++)for(var b=0;b<this.w;b++){var c=this.index(b,a);if(!(this.zbuf[c]<1e-5)){for(var d=0,e=0;e<2*m.PI-1e-4;e+=m.PI/12)d+=m.PI/2-m.atan(max_elevation_angle(this.zbuf,c,[b,a],[this.w,this.h],[m.sin(e),m.cos(e)],this.log2w));d/=m.PI/2*24;var f=255*d;this.set(b,a,f|f<<8|f<<16),this.calls++}}},flush:function(){this.imgData.data.set(this.buf8),this.ctx.putImageData(this.imgData,0,0)}};vecAdd=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]+b[d]);return c},vecSub=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]-b[d]);return c},dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return m.sqrt(b)},normalize=function(a){var b=dist(a);return res=[a[0]/b,a[1]/b,a[2]/b]},barycentric=function(a,b){var c=cross(vecSub([a[2][0],a[1][0],a[0][0]],[a[0][0],a[0][0],b[0]]),vecSub([a[2][1],a[1][1],a[0][1]],[a[0][1],a[0][1],b[1]]));if(m.abs(c[2])>.01){var d=1/c[2];return[1-(c[0]+c[1])*d,c[1]*d,c[0]*d]}return[-1,1,1]},max_elevation_angle=function(a,b,c,d,e,f){for(var g=0,h=0;30>h;h++){var i=vecAdd(c,[e[0]*h,e[1]*h]);if(i[0]>=d[0]||i[1]>=d[1]||i[0]<0||i[1]<0)return g;var j=dist(vecSub(c,i));if(!(1>j)){var k=(d[1]-m.floor(i[1])<<f)+m.floor(i[0]),l=.007874*(a[k]-a[b]);g=m.max(g,l/j)}}return g};