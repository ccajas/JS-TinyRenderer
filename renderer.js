/*! SoftwareRenderer - ver. 0.1.0 */
function Buffer(a,b,c){var d={ctx:a,w:b,h:c,calls:0,pixels:0,nextline:c,bufWidth:b};for(d.clear=function(a){for(var b=0;b<=d.h;b++)for(var c=0;c<d.bufWidth;c++){var e=d.index(c,b);d.set(c,b,a),d.zbuf[e]=0}d.imgData.data.set(d.buf8)},d.index=function(a,b){return(d.h-b<<d.log2w)+a},d.set=function(a,b,c){var e=c[0]|c[1]<<8|c[2]<<16;d.buf32[d.index(a,b)]=4278190080|e},d.get=function(a,b){return d.buf32[d.index(a,b)]},d.triangle=function(a,b){for(var c=[a[0][0],a[1][0],a[2][0]],e=[a[0][1],a[1][1],a[2][1]],f=[a[0][2],a[1][2],a[2][2]],g=[d.w+1,d.h+1],h=[-1,-1],i=0;i<c.length;i++)for(var j=0;2>j;j++)g[j]=m.min(c[i][j],g[j]),h[j]=m.max(c[i][j],h[j]);if(!(g[0]>d.w||h[0]<0||g[1]>d.h||h[1]<0))for(var k,l,n,o,p,q=0,r=g[1];r<=h[1];r++)for(var s=g[0];s<=h[0];s++){d.pixels++;var t=barycentric(c,[s,r,q]),u=-1e-4;if(!(t[0]<u||t[1]<u||t[2]<u)){q=0;for(var i=0;3>i;i++)q+=c[i][2]*t[i];var v=d.index(s,r);if(d.zbuf[v]<q){k=dot(t,[e[0][0],e[1][0],e[2][0]]),l=dot(t,[e[0][1],e[1][1],e[2][1]]),n=dot(t,[f[0][0],f[1][0],f[2][0]]),o=dot(t,[f[0][1],f[1][1],f[2][1]]),p=dot(t,[f[0][2],f[1][2],f[2][2]]);var w=[0,0,0],x=b.fragment([[k,l],[o,n,p]],w);if(!x){d.zbuf[v]=q,d.set(s,r,w),d.calls++}}}}},d.draw=function(){var a=d;return a.nextline<0?void(end=new Date):(d.postProc(a.nextline),void d.drawBuffer())},d.postProc=function(a){for(var b=[],c=0;c<2*m.PI-1e-4;c+=m.PI/8)b.push([m.sin(c),m.cos(c)]);for(var e=a;e>a-272;e--)for(var f=0;f<d.w;f++){var g=d.index(f,e);if(!(d.zbuf[g]<1e-5)){for(var h=0,i=0;i<b.length;i++)h+=m.PI/2-m.atan(max_elevation_angle(d.zbuf,g,[f,e],[d.w,d.h],b[i],d.log2w));h/=m.PI/2*b.length;var j=this.get(f,e),k=(255&j)*h,l=(j>>8&255)*h,n=(j>>16&255)*h;d.set(f,e,new Uint8Array([k,l,n])),d.calls++}}},d.drawBuffer=function(){d.imgData.data.set(d.buf8),d.ctx.putImageData(d.imgData,0,0)},d.log2w=1;d.bufWidth>>=1;)d.log2w++;return d.bufWidth=1<<d.log2w,d.imgData=a.createImageData(d.bufWidth,d.h),d.buf=new ArrayBuffer(d.imgData.data.length),d.buf8=new Uint8ClampedArray(d.buf),d.buf32=new Uint32Array(d.buf),d.zbuf=new Uint32Array(d.imgData.data.length),d}function Texture(a){var b={texData:null,buf32:null,sampled:!1,source:""};return b.load=function(a){img=new Image,img.src=a,img.onload=function(){texCanvas=document.createElement("canvas"),ctx=texCanvas.getContext("2d"),texCanvas.width=img.width,texCanvas.height=img.height,ctx.drawImage(img,0,0),img.style.display="none",b.texData=ctx.getImageData(0,0,img.width,img.height);var a=new ArrayBuffer(b.texData.data.length);b.buf32=new Uint32Array(a);for(var c=0;c<b.buf32.length;c++){var d=b.texData.data,e=c<<2;b.buf32[c]=d[e]|d[e+1]<<8|d[e+2]<<16|d[e+3]<<24}}},b.sample=function(a,c){b.texData.data;const d=m.floor(c[0]*b.texData.width),e=m.floor(c[1]*b.texData.height);return i=(b.texData.height-e)*b.texData.width+d,smp=b.buf32[i],new Uint8Array([smp,smp>>8,smp>>16,smp>>24])},b.load(a),b}function Matrix(){var a={rows:[]};return a.identity(),a.rows=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],a.rows}function modelReady(a,b){return function(){console.log("ready to render!"),effect=new DefaultEffect;var a=Texture("obj/diablo3/diablo3_pose_diffuse.png"),c=b.getContext("2d"),d=doc.getElementById("render_start");d.style.display="block",d.onclick=function(){console.log("Begin render!"),img=Buffer(c,b.width,b.height),effect.setParameters({scr_w:img.w,scr_h:img.h,texture:a}),drawImage()}}}function drawImage(){img.clear([255,255,255]),start=new Date,console.log((new Date).getTime()-start.getTime()+"ms Drawing triangles"),effect.setParameters({r:theta});for(var a=0;a<model.faces.length;a++){for(var b=model.faces[a],c=[],d=0;3>d;d++){var e=model.verts[b[d][0]],f=model.texcoords.length>0?model.texcoords[b[d][1]]:[0,0],g=model.normals.length>0?model.normals[b[d][2]]:[1,0,0],h=[e,f,g],i=effect.vertex(h);c.push(i)}s1=vecSub(c[1][0],c[0][0]),s2=vecSub(c[2][0],c[0][0]),dir=cross(s1,s2),dot(normalize(dir),[0,0,1])>0&&img.triangle(c,effect)}var j="Frame took "+((new Date).getTime()-start.getTime())+" ms",k="Pixels drawn/found "+img.calls+"/"+img.pixels;console.log(k),doc.getElementById("info").innerHTML=j+"<br/>"+k,img.drawBuffer(),img.calls=0,img.pixels=0,theta+=.1,requestAnimationFrame(function(){drawImage()})}var OBJmodel={verts:[],faces:[],normals:[],texcoords:[],load:function(a,b){var c=this,d=function(a){var d=a.split("\n");c.parse(d),b()},e=function(a){console.error("request failed!")};request(a).then(d,e)},parse:function(a){for(var b=function(b){return a[b].split(" ").splice(1,3)},c=0;c<a.length;c++)switch(a[c].substr(0,2)){case"v ":this.verts.push(new Float64Array(b(c)));break;case"vn":this.normals.push(new Float64Array(b(c)));break;case"vt":this.texcoords.push(new Float64Array(b(c)));break;case"f ":for(var d=b(c),e=0;3>e;e++)d[e]=d[e].split("/").map(function(a){return parseInt(a-1)});this.faces.push(d)}console.log("total verts: "+this.verts.length),console.log("total normals: "+this.normals.length),console.log("total faces: "+this.faces.length)}},request=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})},Effect={vertex:function(a){},fragment:function(a,b){},setParameters:function(a){var b=this;Object.keys(a).map(function(c){b[c]=a[c]})}},DefaultEffect=function(){};DefaultEffect.prototype=Object.create(Effect),DefaultEffect.prototype.vertex=function(a){var b=a[0],c=a[2],d=this.scr_h/this.scr_w,e=c[0]*m.cos(this.r)-c[2]*m.sin(this.r),f=c[0]*m.sin(this.r)+c[2]*m.cos(this.r),g=c[1],h=[];h[0]=b[0]*m.cos(this.r)-b[2]*m.sin(this.r),h[1]=b[0]*m.sin(this.r)+b[2]*m.cos(this.r);var i=m.floor((h[0]/2+.5/d)*this.scr_w*d),j=m.floor((b[1]/2+.5)*this.scr_h),k=m.floor(65536*(h[1]/2+.5));return[[i,j,k],a[1],[e,g,f]]},DefaultEffect.prototype.fragment=function(a,b){var c=a[1],d=.15,e=dot(c,[0,0,1]),f=this.texture.sample(null,a[0]);return e=m.max(e,0)*(1-d)+d,b[0]=f[0]*e,b[1]=f[1]*e,b[2]=f[2]*e,!1},viewport=function(a,b,c,d){var e=Matrix();return e[0][3]=a+c/2,e[1][3]=b+d/2,e[2][3]=1,e[0][0]=c/2,e[1][1]=d/2,e[2][2]=0,e},projection=function(a){var b=Matrix();return b[3][2]=a,b},lookat=function(a,b,c){for(var d=normalize(vecSub(a,b)),e=normalize(cross(c,d)),f=normalize(cross(d,e)),g=Matrix(),h=Matrix(),i=0;3>i;i++)g[0][i]=e[i],g[1][i]=f[i],g[2][i]=d[i],h[i][3]=-b[i];ModelView=Minv*Tr},vecAdd=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]+b[d]);return c},vecSub=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]-b[d]);return c},dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return m.sqrt(b)},normalize=function(a){var b=dist(a);return[a[0]/b,a[1]/b,a[2]/b]},barycentric=function(a,b){var c=vecSub(a[1],a[0]),d=vecSub(a[2],a[0]),e=vecSub(b,a[0]),f=1/(c[0]*d[1]-d[0]*c[1]);return v=(e[0]*d[1]-d[0]*e[1])*f,w=(c[0]*e[1]-e[0]*c[1])*f,u=1-v-w,[u,v,w]},max_elevation_angle=function(a,b,c,d,e,f){for(var g=0,h=1;40>h;h+=2){var i=vecAdd(c,[e[0]*h,e[1]*h]);if(i[0]>=d[0]||i[1]>=d[1]||i[0]<0||i[1]<0)return g;var j=dist(vecSub(c,i));if(!(1>j)){var k=(d[1]-m.floor(i[1])<<f)+m.floor(i[0]),l=.002*(a[k]-a[b]);g=m.max(g,l/j)}}return g};var m=Math,doc=document;(function(){var a=doc.getElementById("render");model=Object.create(OBJmodel),a.getContext?model.load("obj/diablo3/diablo3.obj",modelReady(model,a)):console.error("Canvas context not supported!")}).call(this);var model,img,effect,theta=0;