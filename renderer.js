/*! SoftwareRenderer - ver. 0.1.0 */
OBJmodel=function(){function a(){this.verts=[],this.faces=[],this.normals=[],this.texcoords=[]}return a.parse=function(a,b){for(var c=function(b){return a[b].split(" ").splice(1,3)},d=0;d<a.length;d++)switch(a[d].substr(0,2)){case"v ":b.verts.push(new f32a(c(d)));break;case"vn":b.normals.push(new f32a(c(d)));break;case"vt":b.texcoords.push(new f32a(c(d)));break;case"f ":for(var e=c(d),f=0;3>f;f++)e[f]=e[f].split("/").map(function(a){return parseInt(a-1)});b.faces.push(e)}console.log("total verts: "+b.verts.length),console.log("total normals: "+b.normals.length),console.log("total faces: "+b.faces.length)},a}(),Matrix=function(){function a(){}return a.identity=function(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},a.mul=function(a,b){var c=[];if(!Array.isArray(b[0])){var d=[a[0][0]*b[0]+a[0][1]*b[1]+a[0][2]*b[2]+a[0][3]*b[3],a[1][0]*b[0]+a[1][1]*b[1]+a[1][2]*b[2]+a[1][3]*b[3],a[2][0]*b[0]+a[2][1]*b[1]+a[2][2]*b[2]+a[2][3]*b[3]];return d}for(var e=0;4>e;e++)c[e]=[Vec4.dot(a[e],[b[0][0],b[1][0],b[2][0],b[3][0]]),Vec4.dot(a[e],[b[0][1],b[1][1],b[2][1],b[3][1]]),Vec4.dot(a[e],[b[0][2],b[1][2],b[2][2],b[3][2]]),Vec4.dot(a[e],[b[0][3],b[1][3],b[2][3],b[3][3]])];return c},a.scale=function(a,b,c){return[[a,0,0,0],[0,b,0,0],[0,0,c,0],[0,0,0,1]]},a.rotation=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return[[1-2*c*c-2*d*d,2*b*c+2*d*e,2*b*d-2*c*e,0],[2*b*c-2*d*e,1-2*b*b-2*d*d,2*d*c+2*b*e,0],[2*b*d+2*c*e,2*d*c-2*b*e,1-2*b*b-2*c*c,0],[0,0,0,1]]},a.view=function(b,c,d){for(var e=Vec3.normalize([b[0]-c[0],b[1]-c[1],b[2]-c[2]]),f=Vec3.normalize(Vec3.cross(d,e)),d=Vec3.normalize(Vec3.cross(e,f)),g=a.identity(),h=0;3>h;h++)g[0][h]=f[h],g[1][h]=d[h],g[2][h]=e[h];return g[3][0]=-Vec3.dot(f,b),g[3][1]=-Vec3.dot(d,b),g[3][2]=-Vec3.dot(e,b),g},a.projection=function(b,c,d,e){var f=a.identity();if(0==c||0>=b)return f;var g=e-d,h=1/g;return f[1][1]=1/m.tan(.5*b),f[0][0]=f[1][1]/c,f[2][2]=e*h,f[3][2]=-e*d*h,f[2][3]=1,f[3][3]=0,f},a}(),Quaternion=function(){function a(){}return a.fromEuler=function(a,b,c){var d,e,f,g,h,i;return g=m.sin(.5*a),d=m.cos(.5*a),h=m.sin(.5*b),e=m.cos(.5*b),i=m.sin(.5*c),f=m.cos(.5*c),[d*e*f+g*h*i,g*e*f-d*h*i,d*h*f+g*e*i,d*e*i-g*h*f]},a}(),Vec3=function(){function a(){}return a.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},a.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},a.reflect=function(b,c){var d=a.dot(b,c),e=[2*c[0]*d,2*c[1]*d,2*c[2]*d];return[e[0]-b[0],e[1]-b[1],e[2]-b[2]]},a.dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return m.sqrt(b)},a.normalize=function(b){var c=1/a.dist(b);return[b[0]*c,b[1]*c,b[2]*c]},a}(),Vec4=function(){function a(){}return a.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},a}(),orient2d=function(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(b[1]-a[1])*(c[0]-a[0])},Buffer=function(){function a(a,b,c){this.ctx=a,this.w=b,this.h=c,this.calls=0,this.pixels=0,this.imgData=a.createImageData(this.w,this.h),this.buf=new ArrayBuffer(this.imgData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf),this.zbuf=new Uint32Array(this.imgData.data.length),this.points=new Int32Array(3)}return a.prototype={clear:function(a){for(var b=0;b<=this.h;b++)for(var c=0;c<this.w;c++){var d=b*this.w+c;this.set(c,b,a),this.zbuf[d]=0}},set:function(a,b,c){var d=255&c[0]|(255&c[1])<<8|(255&c[2])<<16;this.buf32[b*this.w+a]=4278190080|d},get:function(a,b){return this.buf32[b*this.w+a]},drawTriangle:function(a,b){for(var c=[a[0][0],a[1][0],a[2][0]],d=[a[0][1],a[1][1],a[2][1]],e=[a[0][2],a[1][2],a[2][2]],f=[this.w+1,this.h+1],g=[-1,-1],h=0;h<c.length;h++)for(var i=0;2>i;i++)f[i]=m.min(c[h][i],f[i]),g[i]=m.max(c[h][i],g[i]);if(!(f[0]>this.w||g[0]<0||f[1]>this.h||g[1]<0))for(var j,k,l,n,o=new f32a(2),p=new f32a(3),q=c[0][1]-c[1][1],r=c[1][0]-c[0][0],s=c[1][1]-c[2][1],t=c[2][0]-c[1][0],u=c[2][1]-c[0][1],v=c[0][0]-c[2][0],w=c[1][1]-c[0][1],x=c[2][1]-c[1][1],y=1/(r*x-t*w),z=orient2d(c[1],c[2],f),A=orient2d(c[2],c[0],f),B=orient2d(c[0],c[1],f),C=[0,0,0],D=f[1];D<=g[1];D++){for(var E=[z,A,B],F=f[0];F<=g[0];F++){if(this.pixels++,(E[0]|E[1]|E[2])>0){p[0]=E[0]*y,p[1]=E[1]*y,p[2]=E[2]*y,n=0;for(var h=0;3>h;h++)n+=c[h][2]*p[h];var G=D*this.w+F;if(this.zbuf[G]<n){var j,k,l;o[0]=p[0]*d[0][0]+p[1]*d[1][0]+p[2]*d[2][0],o[1]=p[0]*d[0][1]+p[1]*d[1][1]+p[2]*d[2][1],j=p[0]*e[0][0]+p[1]*e[1][0]+p[2]*e[2][0],k=p[0]*e[0][1]+p[1]*e[1][1]+p[2]*e[2][1],l=p[0]*e[0][2]+p[1]*e[1][2]+p[2]*e[2][2];var H=b.fragment([o,[j,k,l],a[0][3]],C);if(!H){this.zbuf[G]=n,this.set(F,D,C),this.calls++}}}E[0]+=s,E[1]+=u,E[2]+=q}z+=t,A+=v,B+=r}},drawTriangleSIMD:function(a,b,c){for(var d=[a[0][0],a[1][0],a[2][0]],e=[a[0][1],a[1][1],a[2][1]],f=[a[0][2],a[1][2],a[2][2]],g=[this.w+1,this.h+1],h=[-1,-1],i=0;i<d.length;i++)for(var j=0;2>j;j++)g[j]=m.min(d[i][j],g[j]),h[j]=m.max(d[i][j],h[j]);if(!(g[0]>this.w||h[0]<0||g[1]>this.h||h[1]<0)){var k=SIMD.Float32x4(d[1][1],d[2][1],d[0][1],d[2][0]),l=SIMD.Float32x4(d[0][0],d[1][0],d[1][1],d[2][1]),n=SIMD.Float32x4(d[2][1],d[0][1],d[1][1],d[1][0]),o=SIMD.Float32x4(d[2][0],d[0][0],d[0][1],d[1][1]);store(c,0,sub(k,n)),store(c,4,sub(l,o));for(var p,q=SIMD.Float32x4(c[0],c[1],c[2],0),r=SIMD.Float32x4(c[3],c[4],c[5],0),s=c[6],t=c[7],u=SIMD.Float32x4(d[0][2],d[1][2],d[2][2],0),v=1/((d[1][0]-d[0][0])*t-(d[2][0]-d[1][0])*s),w=SIMD.Float32x4(orient2d(d[1],d[2],g),orient2d(d[2],d[0],g),orient2d(d[0],d[1],g),-1),x=(splat(0),splat(v)),y=[0,0,0],z=SIMD.Float32x4(e[0][0],e[1][0],e[2][0],0),A=SIMD.Float32x4(e[0][1],e[1][1],e[2][1],0),B=SIMD.Float32x4(f[0][0],f[1][0],f[2][0],0),C=SIMD.Float32x4(f[0][1],f[1][1],f[2][1],0),D=SIMD.Float32x4(f[0][2],f[1][2],f[2][2],0),E=g[1];E<=h[1];E++){for(var F=w,G=g[0];G<=h[0];G++){if(store(c,4,F),this.pixels++,(c[4]|c[5]|c[6])>0){var H=mul(F,x);store(c,0,H),store(c,16,mul(u,H)),p=0;for(var i=0;3>i;i++)p+=c[16+i];var I=E*this.w+G;if(this.zbuf[I]<p){store(c,20,mul(z,H)),store(c,24,mul(A,H)),store(c,28,mul(B,H)),store(c,32,mul(C,H)),store(c,36,mul(D,H));var J=SIMD.Float32x4(c[20],c[24],c[28],c[32]),K=SIMD.Float32x4(c[21],c[25],c[29],c[33]),L=SIMD.Float32x4(c[22],c[26],c[30],c[34]),M=SIMD.Float32x4(c[36],0,0,0),N=SIMD.Float32x4(c[37],0,0,0),O=SIMD.Float32x4(c[38],0,0,0);L=add(add(J,K),L),O=add(add(M,N),O),store(c,20,L),store(c,24,O);var P=b.fragment([[c[20],c[21]],[c[22],c[23],c[24]],a[0][3]],y);if(!P){this.zbuf[I]=p,this.set(G,E,y),this.calls++}}}F=add(F,q)}w=add(w,r)}}},draw:function(){this.imgData.data.set(this.buf8),this.ctx.putImageData(this.imgData,0,0)}},a}(),Effect=function(){function a(){}return a.prototype={vertex:function(a){},fragment:function(a,b){},setParameters:function(a){var b=this;Object.keys(a).map(function(c){b[c]=a[c]})}},a}(),Texture=function(){function a(a,b,c){this.texData=b,this.buf32=c,this.source=a,this.sample=function(a,b){var c=(this.texData.data,m.floor(b[0]*this.texData.width)),d=m.floor(b[1]*this.texData.height);return i=(this.texData.height-d)*this.texData.width+c,smp=this.buf32[i],[255&smp,smp>>8&255,smp>>16&255,smp>>24&255]}}return a.load=function(b){texCanvas=document.createElement("canvas"),ctx=texCanvas.getContext("2d"),texCanvas.width=b.width,texCanvas.height=b.height,ctx.drawImage(b,0,0),b.style.display="none";for(var c=ctx.getImageData(0,0,b.width,b.height),d=new ArrayBuffer(c.data.length),e=new Uint32Array(d),f=0;f<e.length;f++){var g=c.data,h=f<<2;e[f]=g[h]|g[h+1]<<8|g[h+2]<<16|g[h+3]<<24}return new a(b.src,c,e)},a}(),ContentManager=function(){function a(){}function b(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})}function c(a){console.error("request failed!")}function d(){i++,i==j&&(console.info("All content is ready"),h(k))}function e(a,e){j++;var f=function(a){if(null!=e){var b=new OBJmodel,c=a.split("\n");OBJmodel.parse(c,b),k[e]=b,d()}};return b(a).then(f,c)}function f(a,e){j++;var f=function(b){if(null!=e){var c=new Image;c.src=a,c.onload=function(){var a=Texture.load(c);k[e]=a,d()}}};return b(a).then(f,c)}function g(a,b){j++;var c=document.createElement("script");c.src=a,c.onload=function(){null!=b&&b(),d()},document.head.appendChild(c)}var h,i=0,j=0,k={};return a.prototype={load:function(a){return function(b,c){switch(c="undefined"!=typeof c?c:null,a){case"Model":return e(b,c);case"Texture":return f(b,c);case"Effect":return g(b,c)}}},contentCollection:function(){return k},finishedLoading:function(a){h=a}},a}(),function(){m=Math,doc=document,f32a=Float32Array,f64a=Float64Array,simdSupported="undefined"!=typeof SIMD,simdEnabled=!1,Renderer=function(){function a(){}var b,c,d,e=m.PI;if(simdSupported){add=SIMD.Float32x4.add,sub=SIMD.Float32x4.sub,mul=SIMD.Float32x4.mul,splat=SIMD.Float32x4.splat,store=SIMD.Float32x4.store,tbuf=new f32a(48),simdEnabled=!0;var f=doc.getElementById("simd_toggle");f.innerText="SIMD is on!",f.disabled=!1,doc.getElementById("top_info").insertAdjacentHTML("beforeend",'<span class="midblue">&nbsp;SIMD optimized!</span>')}return drawImage=function(){b.clear([0,0,0]),start=new Date;var a=Quaternion.fromEuler(0,e,0),f=Matrix.rotation(Quaternion.fromEuler(0,e,0));console.log(a,f);var g=Matrix.view([0,0,1],[0,0,-1],[0,1,0]),h=Matrix.projection(m.PI/2,16/9,.1,100);c.setParameters({m_world:f,m_view:g,m_proj:h});for(var i=0;i<d.faces.length;i++){for(var j=[],k=d.faces[i],l=0;3>l;l++){var n=d.verts[k[l][0]],o=d.texcoords.length>0?d.texcoords[k[l][1]]:[0,0],p=d.normals.length>0?d.normals[k[l][2]]:[1,0,0],q=[n,o,p],r=c.vertex(q);j.push(r)}simdSupported&&simdEnabled?b.drawTriangleSIMD(j,c,tbuf):b.drawTriangle(j,c)}b.draw(),e+=m.max(.001*((new Date).getTime()-start.getTime()),1/60);var s="Frame took "+((new Date).getTime()-start.getTime())+" ms",t="Pixels drawn/found "+b.calls+"/"+b.pixels;doc.getElementById("info").innerHTML=s+"<br/>"+t,b.calls=0,b.pixels=0,requestAnimationFrame(function(){})},a.prototype={ready:function(a){return console.log("ready to render!"),function(e){d=e.model,c=new DefaultEffect;var f=e.model_diff,g=e.model_nrm,h=a.getContext("2d"),i=doc.getElementById("render_start"),j=doc.getElementById("simd_toggle");b=new Buffer(h,a.width,a.height),c.setParameters({scr_w:b.w,scr_h:b.h,texture:f,texture_nrm:g}),i.style.display="block",i.onclick=function(){console.log("Begin render!"),startProfile=new Date,drawImage()},j.onclick=function(){simdSupported&&(simdEnabled=!simdEnabled,j.innerText="SIMD is "+(simdEnabled?"on!":"off!"))}}}},a}()}();