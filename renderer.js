/*! SoftwareRenderer - ver. 0.1.0 */
function drawInit(){var a=document.getElementById("render"),b=Object.create(OBJmodel);if(a.getContext){var c=a.getContext("2d"),d=drawImage(b,c);b.load("obj/diablo3.obj",d)}else console.error("Canvas context not supported!")}function drawImage(a,b){var c=function(){var c=Object.create(Img);c.init(b),console.log("Canvas loaded");var d=0;c.clear(0),start=new Date;Math.cos(d),Math.sin(d);for(var e=0;e<a.faces.length;e++){for(var f=a.faces[e],g=[],h=[],i=0;3>i;i++){var j=a.verts[f[i][0]-1],k=Math.floor((j[0]/2+.5)*c.h),l=Math.floor((j[1]/2+.5)*c.w),m=Math.floor(256*(j[2]/2+.5));h[i]=[k,l,m],g[i]=j}var n=c.util.cross(c.util.vecSub(g[2],g[0]),c.util.vecSub(g[1],g[0])),o=c.util.dot(c.util.normalize(n),[0,0,-1]),p=255*o;o>0&&c.triangle(h,p+(p<<8)+(p<<16))}end=new Date;var q="Execution took "+(end.getTime()-start.getTime())+" ms",r="<br/>Pixel draw calls: "+c.calls;c.flush(),document.getElementById("info").innerHTML=q+r,d+=.01};return c}function drawZbuffer(a,b){}var OBJmodel=new Object;OBJmodel.verts=[],OBJmodel.faces=[],OBJmodel.normals=[],OBJmodel.request=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})},OBJmodel.load=function(a,b){var c=this,d=function(a){var d=a.split("\n");c.parse(d),b()},e=function(a){console.error("request failed!")};c.request(a).then(d,e)},OBJmodel.parse=function(a){for(var b=0;b<a.length;b++){if(0==a[b].indexOf("v ")){var c=a[b].split(" ").splice(1,3);this.verts.push(c)}if(0==a[b].indexOf("f ")){for(var d=a[b].split(" ").splice(1,3),e=0;3>e;e++)d[e]=d[e].split("/");this.faces.push(d)}}console.log("total verts: "+this.verts.length),console.log("total faces: "+this.faces.length)};var Img=new Object;Img.ctx=null,Img.imgData=null,Img.util=null,Img.init=function(a){this.ctx=a,this.util=Object.create(Util),this.calls=0;var b=a.canvas.clientWidth;for(this.log2width=1;b>>=1;)this.log2width++;b=1<<this.log2width,this.w=a.canvas.clientWidth,this.h=a.canvas.clientHeight,this.imgData=a.createImageData(b,this.h),this.buf=new ArrayBuffer(this.imgData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf),this.zbuffer=new Uint32Array(this.imgData.data.length)},Img.clear=function(a){const b=this.buf32.length;for(var c=0;b>c;c++)this.buf32[c]=a+4278190080},Img.set=function(a,b,c){const d=(this.h-b<<this.log2width)+a;this.buf32[d]=c+4278190080},Img.get=function(a,b){const c=(this.h-b<<this.log2width)+a;return this.buf32[c]},Img.line=function(a,b,c,d,e){var f=!1;Math.abs(a-c)<Math.abs(b-d)&&(b=[a,a=b][0],d=[c,c=d][0],f=!0),a>c&&(c=[a,a=c][0],d=[b,b=d][0]);const g=c-a,h=d-b,i=Math.abs(h/g);for(var j=0,k=b,l=a;c>=l;l++)f?this.set(l,k,e):this.set(k,l,e),j+=i,j>.5&&(k+=d>b?1:-1,j--);this.calls+=c-a+1},Img.triangle=function(a,b){const c=this.util.findBbox(a,[this.w,this.h]);var d=[-1,-1,0];for(d[0]=c[0][0];d[0]<=c[1][0];d[0]++)for(d[1]=c[0][1];d[1]<=c[1][1];d[1]++){var e=this.util.barycentric(a,d);if(d[2]=0,!(e[0]<0||e[1]<0||e[2]<0)){for(var f=0;3>f;f++)d[2]+=a[f][2]*e[f];var g=(this.h-d[1]<<this.log2width)+d[0];this.zbuffer[g]<d[2]&&(this.zbuffer[g]=d[2],this.set(d[0],d[1],d[2]+(d[2]<<8)+(d[2]<<16)),this.calls++)}}},Img.flush=function(){for(var a=0;a<this.w;a++)for(var b=0;b<this.h;b++){var c=(this.h-b<<this.log2width)+a;if(!(this.zbuffer[c]<1e-5)){for(var d=0,e=0;e<2*Math.PI-1e-4;e+=Math.PI/4)d+=Math.PI/2-this.util.max_elevation_angle(this.zbuffer,c,[a,b],[this.w,this.h],[Math.cos(e),Math.sin(e)],this.log2width);d/=Math.PI/2*8,d=Math.pow(d,1),this.set(a,b,255*d+(255*d<<8)+(255*d<<16))}}this.imgData.data.set(this.buf8),this.ctx.putImageData(this.imgData,0,0),console.log("Pixel draw calls: "+this.calls),this.calls=0};var Util=new Object;Util.findBbox=function(a,b){for(var c=[b[0]+1,b[1]+1],d=[-1,-1],e=0;e<a.length;e++)for(var f=0;2>f;f++)c[f]=Math.min(a[e][f],c[f]),d[f]=Math.max(a[e][f],d[f]);return[c,d]},Util.vecAdd=function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]+b[d];return c},Util.vecSub=function(a,b){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]-b[d];return c},Util.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)},Util.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},Util.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},Util.dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return Math.sqrt(b)},Util.normalize=function(a){for(var b=this.dist(a),c=[],d=0;d<a.length;d++)c[d]=a[d]/b;return c},Util.barycentric=function(a,b){var c=this.cross([a[2][0]-a[0][0],a[1][0]-a[0][0],a[0][0]-b[0]],[a[2][1]-a[0][1],a[1][1]-a[0][1],a[0][1]-b[1]]);return Math.abs(c[2])<1?[-1,1,1]:[1-(c[0]+c[1])/c[2],c[1]/c[2],c[0]/c[2]]},Util.max_elevation_angle=function(a,b,c,d,e,f){for(var g=0,h=0;50>h;h++){var i=this.vecAdd(c,[e[0]*h,e[1]*h]);if(i[0]>=d[0]||i[1]>=d[1]||i[0]<0||i[1]<0)return g;var j=this.dist(this.vecSub(c,i));if(!(1>j)){var k=(d[1]-Math.floor(i[1])<<f)+Math.floor(i[0]),l=a[k]-a[b];g=Math.max(g,Math.atan(l/j))}}return g};