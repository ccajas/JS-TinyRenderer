/*! SoftwareRenderer - ver. 0.1.0 */
function modelReady(a,b){return function(){console.log("ready to render!"),effect=new DefaultEffect;var a=new Texture("obj/diablo3/diablo3_pose_diffuse_sm.png"),c=b.getContext("2d"),d=doc.getElementById("render_start");d.style.display="block",d.onclick=function(){console.log("Begin render!"),img=new Buffer(c,b.width,b.height),effect.setParameters({scr_w:img.w,scr_h:img.h,texture:a}),startProfile=new Date,drawImage()}}}function drawImage(){img.clear([255,255,255]),start=new Date,effect.setParameters({r:theta});for(var a=0;a<model.faces.length;a++){for(var b=model.faces[a],c=[],d=0;3>d;d++){var e=model.verts[b[d][0]],f=model.texcoords.length>0?model.texcoords[b[d][1]]:[0,0],g=model.normals.length>0?model.normals[b[d][2]]:[1,0,0],h=[e,f,g],i=effect.vertex(h);c.push(i)}img.triangle(c,effect)}img.calls=0,img.pixels=0,img.draw(),theta+=.001*((new Date).getTime()-start.getTime());var j="Frame took "+((new Date).getTime()-start.getTime())+" ms",k="Pixels drawn/found "+img.calls+"/"+img.pixels;doc.getElementById("info").innerHTML=j+"<br/>"+k,requestAnimationFrame(function(){drawImage()})}var OBJmodel={verts:[],faces:[],normals:[],texcoords:[],load:function(a,b){var c=this,d=function(a){var d=a.split("\n");c.parse(d),b()},e=function(a){console.error("request failed!")};request(a).then(d,e)},parse:function(a){for(var b=function(b){return a[b].split(" ").splice(1,3)},c=0;c<a.length;c++)switch(a[c].substr(0,2)){case"v ":this.verts.push(f32x4(b(c)));break;case"vn":this.normals.push(f32x4(b(c)));break;case"vt":this.texcoords.push(f32x4(b(c)));break;case"f ":for(var d=b(c),e=0;3>e;e++)d[e]=d[e].split("/").map(function(a){return parseInt(a-1)});this.faces.push(d)}console.log("total verts: "+this.verts.length),console.log("total normals: "+this.normals.length),console.log("total faces: "+this.faces.length)}},request=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.onload=function(){200==d.status?b(d.response):c(Error(d.statusText))},d.onerror=c,d.send(null)})};viewport=function(a,b,c,d){var e=Matrix();return e[0][3]=a+c/2,e[1][3]=b+d/2,e[2][3]=1,e[0][0]=c/2,e[1][1]=d/2,e[2][2]=0,e},projection=function(a){var b=Matrix();return b[3][2]=a,b},lookat=function(a,b,c){for(var d=normalize(vecSub(a,b)),e=normalize(cross(c,d)),f=normalize(cross(d,e)),g=Matrix(),h=Matrix(),i=0;3>i;i++)g[0][i]=e[i],g[1][i]=f[i],g[2][i]=d[i],h[i][3]=-b[i];ModelView=Minv*Tr},Matrix=function(){function a(){}return a.identity=function(){return[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]},a.mul=function(a,b){var c=[];return c},a.rotation=function(a,b,c,d){return[[1-2*b*b-2*c*c,2*a*b+2*c*d,2*a*c-2*b*d,0],[2*a*b-2*c*d,1-2*a*a-2*c*c,2*c*b+2*a*d,0],[2*a*c+2*b*d,2*c*b-2*a*d,1-2*a*a-2*b*b,0],[0,0,0,1]]},a}(),Vec3=function(){function a(){}return a.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},a.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},a.dist=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c]*a[c];return m.sqrt(b)},a.normalize=function(b){var c=1/a.dist(b);return[b[0]*c,b[1]*c,b[2]*c]},a}(),orient2d=function(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(b[1]-a[1])*(c[0]-a[0])},barycentric=function(a,b){var c=a[0],d=a[1],e=a[2],f=[d[0]-c[0],d[1]-c[1],d[2]-c[2]],g=[e[0]-c[0],e[1]-c[1],e[2]-c[2]],h=[b[0]-c[0],b[1]-c[1],b[2]-c[2]],i=1/(f[0]*g[1]-g[0]*f[1]);return v=(h[0]*g[1]-g[0]*h[1])*i,w=(f[0]*h[1]-h[0]*f[1])*i,u=1-v-w,[u,v,w]},max_elevation_angle=function(a,b,c,d,e,f){for(var g=0,h=1;40>h;h+=3){var i=[c[0]+e[0]*h,c[1]+e[1]*h];if(i[0]>=d[0]||i[1]>=d[1]||i[0]<0||i[1]<0)return g;var j=Vec3.dist([c[0]-i[0],c[1]-i[1]]);if(!(1>j)){var k=(d[1]-m.floor(i[1])<<f)+m.floor(i[0]),l=.002*(a[k]-a[b]);g=m.max(g,l/j)}}return g},Buffer=function(){function a(a,b,c){for(this.ctx=a,this.w=b,this.h=c,this.calls=0,this.pixels=0,this.bufWidth=b,this.log2w=1;this.bufWidth>>=1;)this.log2w++;this.bufWidth=1<<this.log2w,this.imgData=a.createImageData(this.bufWidth,this.h),this.buf=new ArrayBuffer(this.imgData.data.length),this.buf8=new Uint8ClampedArray(this.buf),this.buf32=new Uint32Array(this.buf),this.zbuf=new Uint32Array(this.imgData.data.length)}return a.prototype={clear:function(a){for(var b=0;b<=this.h;b++)for(var c=0;c<this.bufWidth;c++){var d=this.index(c,b);this.set(c,b,a),this.zbuf[d]=0}},index:function(a,b){return(this.h-b<<this.log2w)+a},set:function(a,b,c){var d=c[0]|c[1]<<8|c[2]<<16;this.buf32[this.index(a,b)]=4278190080|d},get:function(a,b){return this.buf32[this.index(a,b)]},triangle:function(a,b){for(var c=[a[0][0],a[1][0],a[2][0]],d=[a[0][1],a[1][1],a[2][1]],e=[a[0][2],a[1][2],a[2][2]],f=[this.w+1,this.h+1],g=[-1,-1],h=0;h<c.length;h++)for(var i=0;2>i;i++)f[i]=m.min(c[h][i],f[i]),g[i]=m.max(c[h][i],g[i]);if(!(f[0]>this.w||g[0]<0||f[1]>this.h||g[1]<0))for(var j,k,l,n,o,p=c[0][1]-c[1][1],q=c[1][0]-c[0][0],r=c[1][1]-c[2][1],s=c[2][0]-c[1][0],t=c[2][1]-c[0][1],u=c[0][0]-c[2][0],v=orient2d(c[1],c[2],f),w=orient2d(c[2],c[0],f),x=orient2d(c[0],c[1],f),y=[0,0,0],z=0,A=f[1];A<=g[1];A++){for(var B=[v,w,x],C=f[0];C<=g[0];C++)if(this.pixels++,B[0]+=r,B[1]+=t,B[2]+=p,!(B[0]<r||B[1]<t||B[2]<p)){bc=barycentric(c,[C,A,z]),z=0;for(var h=0;3>h;h++)z+=c[h][2]*bc[h];var D=this.index(C,A);if(this.zbuf[D]<z){j=bc[0]*d[0][0]+bc[1]*d[1][0]+bc[2]*d[2][0],k=bc[0]*d[0][1]+bc[1]*d[1][1]+bc[2]*d[2][1],l=bc[0]*e[0][0]+bc[1]*e[1][0]+bc[2]*e[2][0],n=bc[0]*e[0][1]+bc[1]*e[1][1]+bc[2]*e[2][1],o=bc[0]*e[0][2]+bc[1]*e[1][2]+bc[2]*e[2][2];var E=b.fragment([[j,k],[n,l,o]],y);if(!E){this.zbuf[D]=z,this.set(C,A,y),this.calls++}}}v+=s,w+=u,x+=q}},postProc:function(){for(var a=this.h;a>0;a--)for(var b=0;b<this.w;b++){for(var c=[],d=0;d<2*m.PI-1e-4;d+=m.PI/(3*m.random()+2))c.push([m.sin(d),m.cos(d)]);var e=this.index(b,a);if(!(this.zbuf[e]<1e-5)){for(var f=0,g=0;g<c.length;g++)f+=m.PI/2-m.atan(max_elevation_angle(this.zbuf,e,[b,a],[this.w,this.h],c[g],this.log2w));f/=m.PI/2*c.length;var h=16777215,i=(255&h)*f,j=(h>>8&255)*f,k=(h>>16&255)*f;this.set(b,a,[i,j,k]),this.calls++}}},draw:function(){this.imgData.data.set(this.buf8),this.ctx.putImageData(this.imgData,0,0)}},a}(),Effect=function(){function a(){}return a.prototype={vertex:function(a){},fragment:function(a,b){},setParameters:function(a){var b=this;Object.keys(a).map(function(c){b[c]=a[c]})}},a}(),DefaultEffect=function(){function a(){this.setParameters=Effect.prototype.setParameters}return a.prototype={vertex:function(a){var b=a[0],c=a[2],d=this.scr_h/this.scr_w,e=c[0]*m.cos(this.r)-c[2]*m.sin(this.r),f=c[0]*m.sin(this.r)+c[2]*m.cos(this.r),g=c[1],h=[];h[0]=b[0]*m.cos(this.r)-b[2]*m.sin(this.r),h[1]=b[0]*m.sin(this.r)+b[2]*m.cos(this.r);var i=m.floor((h[0]/2+.5/d)*this.scr_w*d),j=m.floor((b[1]/2+.5)*this.scr_h),k=m.floor(65536*(h[1]/2+.5));return[[i,j,k,0],a[1],[e,g,f,0]]},fragment:function(a,b){var c=a[1],d=.15,e=Vec3.dot(c,[0,0,1]),f=this.texture.sample(null,a[0]);return e=m.max(e,0)*(1-d)+d,b[0]=f[0]*e,b[1]=f[1]*e,b[2]=f[2]*e,!1}},a}(),Texture=function(){function a(a){this.texData=null,this.buf32=null,this.source=a,this.load()}return a.prototype={load:function(){img=new Image,img.src=this.source;var a=this;img.onload=function(){texCanvas=document.createElement("canvas"),ctx=texCanvas.getContext("2d"),texCanvas.width=img.width,texCanvas.height=img.height,ctx.drawImage(img,0,0),img.style.display="none",a.texData=ctx.getImageData(0,0,img.width,img.height);var b=new ArrayBuffer(a.texData.data.length);a.buf32=new Uint32Array(b);for(var c=0;c<a.buf32.length;c++){var d=a.texData.data,e=c<<2;a.buf32[c]=d[e]|d[e+1]<<8|d[e+2]<<16|d[e+3]<<24}}},sample:function(a,b){this.texData.data;const c=m.floor(b[0]*this.texData.width),d=m.floor(b[1]*this.texData.height);return i=(this.texData.height-d)*this.texData.width+c,smp=this.buf32[i],new Uint8Array([smp,smp>>8,smp>>16,smp>>24])}},a}(),function(){m=Math,doc=document,f32x4="undefined"==typeof SIMD?function(a){return new Float32Array(a)}:function(a){return SIMD.Float32x4.load(a,0)},model=null,img=null,effect=null,startProfile=null,theta=0,frames=0;var a=doc.getElementById("render");model=Object.create(OBJmodel),a.getContext?model.load("obj/diablo3/diablo3.obj",modelReady(model,a)):console.error("Canvas context not supported!")}.call(this);